<!-- customer/chat_list.html -->
{% extends 'customer/base.html' %}
{% load chat_extras %}

{% block content %}
<div class="chats-container">
    <!-- WhatsApp-style header -->
    <div class="chats-header">
        <div class="header-top">
            <h1 class="header-title">Chats</h1>
            <div class="header-actions">
                <button class="header-icon"><i class="bi bi-camera"></i></button>
                <button class="header-icon"><i class="bi bi-three-dots-vertical"></i></button>
            </div>
        </div>
        
        <!-- Search bar -->
        <div class="search-bar">
            <i class="bi bi-search search-icon"></i>
            <input type="text" 
                   class="search-input" 
                   placeholder="Search chats" 
                   id="chat-search"
                   value="{{ search_query }}">
        </div>
        
        <!-- Filter tabs -->
        <div class="filter-tabs">
            <button class="filter-tab active">All</button>
            <button class="filter-tab">Unread</button>
            <button class="filter-tab">Stores</button>
        </div>
    </div>
    
    <!-- Chats list (WhatsApp style) -->
    <div class="chats-list">
        {% for item in conversation_data %}
        <a href="{% url 'chat_room' item.conversation.id %}" 
           class="chat-item {% if item.unread_count %}unread{% endif %}"
           data-conversation-id="{{ item.conversation.id }}">
            
            <!-- Avatar -->
            <div class="chat-avatar">
                {% if item.conversation.store.store_logo %}
                <img src="{{ item.conversation.store.store_logo.url }}" alt="{{ item.conversation.store.store_name }}">
                {% else %}
                <div class="avatar-placeholder" style="background: #075E54;">
                    {{ item.conversation.store.store_name|first|upper }}
                </div>
                {% endif %}
            </div>
            
            <!-- Chat info -->
            <div class="chat-info">
                <div class="chat-row">
                    <span class="chat-name">{{ item.conversation.store.store_name }}</span>
                    <span class="chat-time">
                        {{ item.conversation.updated_at|timesince }} ago
                    </span>
                </div>
                <div class="chat-row">
                    <div class="chat-last-message">
                        {% if item.last_message %}
                            {% if item.last_message.sender == request.user %}
                            <span class="message-sender">You: </span>
                            {% endif %}
                            {{ item.last_message.content|truncatechars:40 }}
                        {% else %}
                            <span class="no-messages">No messages yet</span>
                        {% endif %}
                    </div>
                    {% if item.unread_count %}
                    <span class="unread-badge">{{ item.unread_count }}</span>
                    {% endif %}
                </div>
                {% if item.conversation.book %}
                <div class="chat-book-info">
                    <i class="bi bi-book"></i>
                    {{ item.conversation.book.title|truncatechars:30 }}
                </div>
                {% endif %}
            </div>
        </a>
        {% empty %}
        <div class="empty-chats">
            <div class="empty-icon">
                <i class="bi bi-chat-dots"></i>
            </div>
            <h3>No chats yet</h3>
            <p>Start a conversation with a store owner from any book page</p>
            <a href="{% url 'customer_dashboard' %}" class="browse-books-btn">
                Browse Books
            </a>
        </div>
        {% endfor %}
    </div>
</div>

<style>
/* WhatsApp-style Chat List */
.chats-container {
    max-width: 600px;
    margin: 0 auto;
    background: white;
    min-height: 100vh;
    box-shadow: 0 0 10px rgba(0,0,0,0.1);
}

/* Header */
.chats-header {
    background: #075E54;
    color: white;
    padding: 15px 16px 8px;
    position: sticky;
    top: 0;
    z-index: 100;
}

.header-top {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
}

.header-title {
    font-size: 24px;
    font-weight: 500;
    margin: 0;
}

.header-actions {
    display: flex;
    gap: 20px;
}

.header-icon {
    background: none;
    border: none;
    color: white;
    font-size: 20px;
    cursor: pointer;
    padding: 0;
}

/* Search bar */
.search-bar {
    background: white;
    border-radius: 24px;
    padding: 8px 16px;
    margin-bottom: 12px;
    display: flex;
    align-items: center;
    background-color: #f0f2f5;
}

.search-icon {
    color: #54656f;
    font-size: 16px;
    margin-right: 10px;
}

.search-input {
    flex: 1;
    border: none;
    outline: none;
    background: transparent;
    font-size: 15px;
    padding: 4px 0;
}

.search-input::placeholder {
    color: #9ca5ad;
}

/* Filter tabs */
.filter-tabs {
    display: flex;
    gap: 8px;
    padding: 4px 0;
}

.filter-tab {
    padding: 8px 16px;
    border: none;
    background: rgba(255,255,255,0.2);
    color: rgba(255,255,255,0.8);
    border-radius: 24px;
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
}

.filter-tab:hover {
    background: rgba(255,255,255,0.3);
}

.filter-tab.active {
    background: white;
    color: #075E54;
}

/* Chat list */
.chats-list {
    background: white;
}

.chat-item {
    display: flex;
    padding: 12px 16px;
    text-decoration: none;
    color: inherit;
    border-bottom: 1px solid #f0f2f5;
    transition: background 0.2s;
    animation: slideIn 0.3s ease;
}

@keyframes slideIn {
    from {
        opacity: 0;
        transform: translateX(-20px);
    }
    to {
        opacity: 1;
        transform: translateX(0);
    }
}

.chat-item:hover {
    background: #f5f6f6;
}

.chat-item.unread {
    background: rgba(7, 94, 84, 0.05);
}

/* Avatar */
.chat-avatar {
    width: 49px;
    height: 49px;
    border-radius: 50%;
    overflow: hidden;
    margin-right: 15px;
    flex-shrink: 0;
}

.chat-avatar img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.avatar-placeholder {
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: 600;
    font-size: 20px;
}

/* Chat info */
.chat-info {
    flex: 1;
    min-width: 0;
}

.chat-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 4px;
}

.chat-name {
    font-weight: 500;
    color: #111;
    font-size: 16px;
}

.chat-time {
    font-size: 12px;
    color: #667781;
}

.chat-last-message {
    font-size: 14px;
    color: #667781;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 200px;
}

.message-sender {
    color: #075E54;
    font-weight: 500;
}

.no-messages {
    color: #999;
    font-style: italic;
}

.unread-badge {
    background-color: #25D366;
    color: white;
    font-size: 12px;
    font-weight: 500;
    min-width: 22px;
    height: 22px;
    border-radius: 11px;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0 6px;
    margin-left: 8px;
}

.chat-book-info {
    font-size: 12px;
    color: #667781;
    margin-top: 2px;
    display: flex;
    align-items: center;
    gap: 4px;
}

.chat-book-info i {
    font-size: 10px;
}

/* Empty state */
.empty-chats {
    text-align: center;
    padding: 60px 20px;
    color: #667781;
}

.empty-icon {
    font-size: 80px;
    margin-bottom: 20px;
    opacity: 0.5;
}

.empty-chats h3 {
    font-size: 18px;
    font-weight: normal;
    margin-bottom: 10px;
    color: #111;
}

.empty-chats p {
    font-size: 14px;
    margin-bottom: 20px;
}

.browse-books-btn {
    display: inline-block;
    padding: 12px 24px;
    background: #075E54;
    color: white;
    text-decoration: none;
    border-radius: 24px;
    font-weight: 500;
    transition: background 0.2s;
}

.browse-books-btn:hover {
    background: #128C7E;
}

/* Responsive */
@media (max-width: 600px) {
    .chats-container {
        max-width: 100%;
    }
    
    .chat-item {
        padding: 10px 12px;
    }
    
    .chat-avatar {
        width: 42px;
        height: 42px;
        margin-right: 12px;
    }
    
    .avatar-placeholder {
        font-size: 16px;
    }
    
    .chat-name {
        font-size: 15px;
    }
    
    .chat-last-message {
        font-size: 13px;
        max-width: 150px;
    }
}

@media (max-width: 480px) {
    .header-title {
        font-size: 20px;
    }
    
    .filter-tabs {
        overflow-x: auto;
        padding-bottom: 8px;
    }
    
    .filter-tab {
        white-space: nowrap;
    }
    
    .chat-last-message {
        max-width: 120px;
    }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('chat-search');
    const chatItems = document.querySelectorAll('.chat-item');
    const filterTabs = document.querySelectorAll('.filter-tab');
    
    // Search functionality
    searchInput.addEventListener('input', function() {
        const query = this.value.toLowerCase().trim();
        
        chatItems.forEach(item => {
            const chatName = item.querySelector('.chat-name').textContent.toLowerCase();
            const lastMessage = item.querySelector('.chat-last-message')?.textContent.toLowerCase() || '';
            const bookInfo = item.querySelector('.chat-book-info')?.textContent.toLowerCase() || '';
            
            if (chatName.includes(query) || lastMessage.includes(query) || bookInfo.includes(query)) {
                item.style.display = 'flex';
            } else {
                item.style.display = 'none';
            }
        });
    });
    
    // Filter tabs
    filterTabs.forEach(tab => {
        tab.addEventListener('click', function() {
            // Remove active class from all tabs
            filterTabs.forEach(t => t.classList.remove('active'));
            this.classList.add('active');
            
            const filter = this.textContent.toLowerCase();
            
            chatItems.forEach(item => {
                if (filter === 'all') {
                    item.style.display = 'flex';
                } else if (filter === 'unread') {
                    item.style.display = item.classList.contains('unread') ? 'flex' : 'none';
                } else if (filter === 'stores') {
                    // Show all stores (all items are stores in customer view)
                    item.style.display = 'flex';
                }
            });
        });
    });
    
    // Update unread count in header
    function updateUnreadCount() {
        const unreadItems = document.querySelectorAll('.chat-item.unread').length;
        const unreadBadge = document.querySelector('.cart-badge');
        if (unreadBadge) {
            unreadBadge.textContent = unreadItems;
            unreadBadge.style.display = unreadItems > 0 ? 'flex' : 'none';
        }
    }
    
    updateUnreadCount();
});
</script>
{% endblock %}