{% extends 'base.html' %}
{% block content %}
<div class="container">
    <h2>Chat Room</h2>
    <div class="chat-box">
        {% for message in messages_list %}
            <div class="chat-message {% if message.sender == user %}sent{% else %}received{% endif %}">
                <strong>{{ message.sender.username }}:</strong> {{ message.content }}
                <span class="timestamp">{{ message.timestamp|date:'H:i' }}</span>
            </div>
        {% empty %}
            <p>No messages yet.</p>
        {% endfor %}
    </div>
    <form method="post" action="{% url 'send_message' conversation.id %}">
        {% csrf_token %}
        <textarea name="content" rows="2" class="form-control" placeholder="Type your message..." id="chat-message-input"></textarea>
        <button type="submit" class="btn btn-primary" style="margin-top:10px;">Send</button>
    </form>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const form = document.querySelector('form');
            const input = document.getElementById('chat-message-input');
            form.addEventListener('submit', function(e) {
                e.preventDefault();
                const content = input.value.trim();
                if (!content) return;
                const csrfToken = document.querySelector('input[name="csrfmiddlewaretoken"]').value;
                fetch(form.action, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    },
                    body: JSON.stringify({ content })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        input.value = '';
                        location.reload();
                    } else {
                        alert(data.error || 'Failed to send message');
                    }
                })
                .catch(() => alert('Error sending message'));
            });
        });
    </script>
    <a href="{% url 'customer_dashboard' %}" class="btn btn-secondary" style="margin-top:15px;">Back to Dashboard</a>
</div>
<style>
.chat-box { background: #f8f9fa; border-radius: 8px; padding: 20px; margin-bottom: 20px; max-height: 400px; overflow-y: auto; }
.chat-message { margin-bottom: 10px; padding: 8px 12px; border-radius: 6px; }
.chat-message.sent { background: #d1e7dd; text-align: right; }
.chat-message.received { background: #f1f1f1; text-align: left; }
.timestamp { font-size: 0.8em; color: #888; margin-left: 8px; }
</style>
{% endblock %}
